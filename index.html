<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Spaced Repetition">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📚</text></svg>">
    <title>Topic Spaced Repetition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffffff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .nav-tabs { gap: 8px; }
            .tab-btn { padding: 10px 16px; font-size: 0.9em; }
            .container { padding: 10px; }
            .content-section { padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; gap: 15px; }
            .interval-options { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .calendar-day { padding: 8px 2px; min-height: 60px; font-size: 0.8em; }
            .topic-item { flex-direction: column; align-items: flex-start; gap: 15px; }
            .topic-actions { width: 100%; justify-content: flex-end; }
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .tab-btn.active, .tab-btn:hover {
            background: linear-gradient(45deg, #10b981, #059669);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .content-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .content-section.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 25px; border-radius: 15px; text-align: center; transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-number { font-size: 2.2em; font-weight: bold; margin-bottom: 5px; }
        .stat-number.due { color: #fbbf24; }
        .stat-number.total { color: #60a5fa; }
        .stat-number.completed { color: #34d399; }
        .today-topics {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px; padding: 25px; margin-top: 20px;
        }

        /* Add Topic */
        .add-form {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px; padding: 30px; margin-bottom: 30px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 12px; border: none; border-radius: 10px;
            background: rgba(255, 255, 255, 0.2); color: white; font-size: 1em;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group input::placeholder, .form-group textarea::placeholder { color: rgba(255, 255, 255, 0.7); }
        .interval-options {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px; margin-top: 15px;
        }
        .interval-btn {
            background: rgba(255, 255, 255, 0.2); border: none; color: white;
            padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;
            font-weight: 600; text-align: center;
        }
        .interval-btn.selected { background: linear-gradient(45deg, #10b981, #059669); box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4); }
        .custom-interval { display: none; margin-top: 15px; align-items: center; gap: 10px; }
        .custom-interval.show { display: flex; }
        .custom-interval input { width: 80px; }
        .btn {
            background: linear-gradient(45deg, #10b981, #059669); border: none; color: white;
            padding: 12px 24px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3); }
        .btn.secondary { background: rgba(255,255,255,.2); border:1px solid rgba(255,255,255,.3); }

        /* Topics List */
        .topic-list { display: grid; gap: 15px; }
        .topic-item {
            background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px;
            display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease;
        }
        .topic-item:hover { background: rgba(255, 255, 255, 0.2); transform: translateX(5px); }
        .topic-info { flex: 1; }
        .topic-title { font-size: 1.2em; font-weight: 600; margin-bottom: 5px; }
        .topic-description { opacity: 0.8; font-size: 0.9em; margin-bottom: 10px; }
        .topic-meta { font-size: 0.8em; opacity: 0.7; }
        .topic-actions { display: flex; gap: 10px; }
        .action-btn {
            background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; font-size: 0.8em; transition: all 0.3s ease;
        }
        .action-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .action-btn.complete { background: linear-gradient(45deg, #10b981, #059669); }
        .action-btn.delete { background: linear-gradient(45deg, #ef4444, #dc2626); }

        /* Calendar */
        .calendar-header { display: flex; justify-content: between; align-items: center; margin-bottom: 30px; }
        .calendar-nav { display: flex; gap: 10px; align-items: center; }
        .calendar-nav button {
            background: rgba(255, 255, 255, 0.2); border: none; color: white;
            padding: 8px 12px; border-radius: 8px; cursor: pointer;
        }
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px;
            background: rgba(255, 255, 255, 0.2); border-radius: 10px; overflow: hidden;
        }
        .calendar-day {
            background: rgba(255, 255, 255, 0.1); padding: 15px 5px; text-align: center; min-height: 80px;
            position: relative; transition: background 0.3s ease; cursor: pointer;
        }
        .calendar-day:hover { background: rgba(255, 255, 255, 0.2); }
        .calendar-day.today { background: linear-gradient(45deg, #10b981, #059669); }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.header-cell { cursor: default; }
        .day-number { font-weight: 600; margin-bottom: 5px; }
        .day-topics { font-size: 0.7em; opacity: 0.9; }
        .topic-dot { display: inline-block; width: 6px; height: 6px; background: #fbbf24; border-radius: 50%; margin: 1px; }
        .no-topics { text-align: center; opacity: 0.7; padding: 40px; font-size: 1.1em; }

        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600; }
        .status-due { background: #fbbf24; color: #000; }
        .status-future { background: rgba(255, 255, 255, 0.3); }
        .status-completed { background: #10b981; }

        /* --- Modal (matches app tone) --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal {
            position: relative; width: min(720px, 94vw);
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 16px; padding: 22px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(18px); color: #fff; max-height: 80vh; overflow-y: auto;
        }
        .modal-title {
            font-size: 1.3em; font-weight: 700; margin-bottom: 12px;
            background: linear-gradient(45deg, #ffffff, #e0e7ff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .modal-summary {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; padding: 12px; margin-bottom: 14px; font-size: 0.95em;
        }
        .modal-section { margin-top: 14px; }
        .modal-section h4 { font-size: 1em; opacity: 0.95; margin-bottom: 10px; }
        .modal-close {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255, 255, 255, 0.18); border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff; width: 32px; height: 32px; border-radius: 10px; cursor: pointer;
            display: grid; place-items: center; font-size: 18px; line-height: 0; transition: all 0.2s ease;
        }
        .modal-close:hover { background: linear-gradient(45deg, #ef4444, #dc2626); }

        /* Cards/Tags inside modal */
        .note-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 14px; padding: 12px 14px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;
        }
        .note-card.pending {
            background: rgba(251, 191, 36, 0.14); /* amber */
            border-color: rgba(251, 191, 36, 0.45);
            box-shadow: 0 6px 16px rgba(251, 191, 36, 0.16);
        }
        .note-card.reviewed {
            background: rgba(16, 185, 129, 0.16); /* emerald */
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.18);
        }
        .card-left { display: grid; gap: 6px; }
        .card-title { font-weight: 700; }
        .card-meta { font-size: 0.85em; opacity: 0.9; }
        .chip { display: inline-block; padding: 3px 10px; border-radius: 999px; font-size: 0.75em; font-weight: 800; }
        .chip-pending { background: #fbbf24; color: #000; }
        .chip-reviewed { background: #10b981; color: #000; }
        .pill {
            display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.72em;
            background: rgba(255,255,255,0.14); border: 1px solid rgba(255,255,255,0.22); margin-right: 6px;
        }

        /* Bulk modal specifics */
        .tabs { display:flex; gap:8px; margin-bottom:14px; }
        .tab {
            padding:8px 14px; border-radius:12px; cursor:pointer; font-weight:700;
            background: rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.25);
        }
        .tab.active { background: linear-gradient(45deg,#10b981,#059669); }
        .tab-panel { display:none; }
        .tab-panel.show { display:block; }
        .preview-box {
            background: rgba(255,255,255,.08);
            border: 1px solid rgba(255,255,255,.18);
            border-radius: 12px; padding: 12px; margin-top: 10px; max-height: 200px; overflow:auto;
        }
        .preview-item { padding:6px 8px; border-bottom: 1px dashed rgba(255,255,255,.15); font-size:.95em; }
        .preview-item:last-child { border-bottom: none; }
        .helper { font-size:.85em; opacity:.85; margin-top:8px; }
        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>📚 Topic Spaced Repetition</h1>
        <p>Organize your learning with smart topic scheduling</p>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="showTab('dashboard')">📊 Dashboard</button>
        <button class="tab-btn" onclick="showTab('add')">➕ Add Topic</button>
        <button class="tab-btn" onclick="showTab('topics')">📝 All Topics</button>
        <button class="tab-btn" onclick="showTab('calendar')">📅 Calendar</button>
    </div>

    <!-- Dashboard -->
    <div class="content-section active" id="dashboard">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number due" id="statsDue">0</div>
                <div class="stat-label">Due Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number total" id="statsTotal">0</div>
                <div class="stat-label">Total Topics</div>
            </div>
            <div class="stat-card">
                <div class="stat-number completed" id="statsCompleted">0</div>
                <div class="stat-label">Completed Today</div>
            </div>
        </div>

        <div class="today-topics">
            <h3 style="margin-bottom: 20px;">📅 Due Today</h3>
            <div id="todayTopicsList"></div>
        </div>
    </div>

    <!-- Add Topic -->
    <div class="content-section" id="add">
        <div class="add-form">
            <h3 style="margin-bottom: 25px;">Add New Topic</h3>

            <div class="form-group">
                <label>Topic Title:</label>
                <input type="text" id="topicTitle" placeholder="e.g., JavaScript Promises">
            </div>

            <div class="form-group">
                <label>Description (optional):</label>
                <textarea id="topicDescription" placeholder="Brief description of what you'll review..."></textarea>
            </div>

            <div class="form-group">
                <label>Review Intervals (Select Multiple):</label>
                <p style="font-size: 0.9em; opacity: 0.8; margin-bottom: 15px;">
                    Choose one or more intervals - topic will repeat on ALL selected schedules
                </p>
                <div class="interval-options" id="mainIntervalOptions">
                    <button class="interval-btn" data-days="1">1 Day</button>
                    <button class="interval-btn" data-days="7">7 Days</button>
                    <button class="interval-btn" data-days="14">14 Days</button>
                    <button class="interval-btn" data-days="30">30 Days</button>
                    <button class="interval-btn" data-days="custom">Custom</button>
                </div>

                <div class="custom-interval" id="customInterval">
                    <input type="number" id="customDays" min="1" max="365" value="1" placeholder="Days">
                    <button type="button" class="btn" style="padding: 8px 16px; margin-left: 10px;" onclick="addCustomInterval()">Add Custom</button>
                </div>

                <div id="selectedIntervals" style="margin-top: 15px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">Selected Intervals:</div>
                    <div id="intervalsList" style="color: #34d399; font-size: 0.9em;">
                        None selected - please choose at least one interval
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top: 10px; gap:12px;">
                <button class="btn" onclick="addTopic()">Add Topic</button>
                <button class="btn secondary" onclick="openBulkModal()">Bulk Add</button>
            </div>
        </div>
    </div>

    <!-- All Topics -->
    <div class="content-section" id="topics">
        <h3 style="margin-bottom: 25px;">All Topics</h3>
        <div class="topic-list" id="topicList"></div>
    </div>

    <!-- Calendar -->
    <div class="content-section" id="calendar">
        <div class="calendar-header">
            <h3 id="calendarTitle">Calendar View</h3>
            <div class="calendar-nav">
                <button onclick="changeMonth(-1)">◀</button>
                <span id="currentMonth"></span>
                <button onclick="changeMonth(1)">▶</button>
                <button onclick="goToToday()">Today</button>
            </div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
</div>

<!-- Modal for day details -->
<div class="modal-overlay" id="dayModal">
    <div class="modal">
        <button class="modal-close" id="modalClose" aria-label="Close">&times;</button>
        <div class="modal-title" id="modalDate">Date</div>
        <div class="modal-summary" id="modalSummary">Summary</div>

        <div class="modal-section" id="pendingSection">
            <h4>🕑 Pending</h4>
            <div id="modalPendingList"></div>
        </div>
        <div class="modal-section" id="reviewedSection">
            <h4>✅ Reviewed</h4>
            <div id="modalReviewedList"></div>
        </div>
    </div>
</div>

<!-- Bulk Add Modal -->
    <div class="modal-overlay" id="bulkModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Bulk Add Topics</div>
                <button class="modal-close" id="bulkCloseBtn">✕</button>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="paste">Paste from Excel/CSV</button>
                <button class="tab" data-tab="upload">Upload CSV</button>
            </div>

            <!-- Paste Panel -->
            <div id="tab-paste" class="tab-panel show">
                <label class="helper">Paste one topic per line. You can also use <b>title, description</b> per line.</label>
                <textarea id="bulkPaste" rows="8" style="width:100%; margin-top:8px; padding:12px; border-radius:12px; border: none; color:#fff; background: rgba(255,255,255,.18);" placeholder="Topic A&#10;Topic B, optional description&#10;Topic C"></textarea>
            </div>

            <!-- Upload Panel -->
            <div id="tab-upload" class="tab-panel">
                <div class="row" style="margin-top:4px;">
                    <input id="bulkFile" type="file" accept=".csv" style="display:none;" />
                    <button class="btn secondary" id="chooseCsvBtn">Choose CSV</button>
                    <span class="helper" id="csvFileName" style="min-height:24px;"></span>
                </div>
                <div class="helper" style="margin-top:10px;">CSV format: <b>title, description</b> (header optional). We handle quoted commas.</div>
            </div>

            <div style="margin-top:16px;">
                <div style="font-weight:700; margin-bottom:8px;">Bulk Intervals</div>
                <div class="interval-options" id="bulkIntervalOptions">
                    <button class="interval-btn" data-days="1">1 Day</button>
                    <button class="interval-btn" data-days="7">7 Days</button>
                    <button class="interval-btn" data-days="14">14 Days</button>
                    <button class="interval-btn" data-days="30">30 Days</button>
                    <button class="interval-btn" data-days="custom">Custom</button>
                </div>
                <div class="custom-interval" id="bulkCustomWrap" style="margin-bottom:8px;">
                    <input type="number" id="bulkCustomDays" min="1" max="365" value="1" placeholder="Days" />
                    <button type="button" class="btn" style="padding: 8px 16px; margin-left: 10px;" id="bulkAddCustomBtn">Add Custom</button>
                </div>
            </div>

            <div style="margin-top:16px;">
                <div style="font-weight:700; margin-bottom:8px;">Preview</div>
                <div id="bulkPreview" class="preview-box">No items yet.</div>
            </div>

            <div class="row" style="margin-top:16px; justify-content:flex-end;">
                <button class="btn secondary" id="bulkCancel">Cancel</button>
                <button class="btn" id="bulkConfirm">Add All</button>
            </div>
        </div>
    </div>

<script>
class TopicSpacedRepetition {
    constructor() {
        this.topics = JSON.parse(localStorage.getItem('srTopics') || '[]');
        this.completedToday = JSON.parse(localStorage.getItem('completedToday') || '[]');
        this.selectedIntervals = [];
        this.bulkSelectedIntervals = [];
        this.currentDate = new Date();

        // Daily reset
        const today = new Date().toDateString();
        const lastDate = localStorage.getItem('lastVisitDate');
        if (lastDate !== today) {
            this.completedToday = [];
            localStorage.setItem('completedToday', '[]');
            localStorage.setItem('lastVisitDate', today);
        }

        // Modal wiring
        this.modal = document.getElementById('dayModal');
        this.modalCloseBtn = document.getElementById('modalClose');
        this.modalCloseBtn.addEventListener('click', () => this.closeDateModal());
        this.modal.addEventListener('click', (e) => {
            if (e.target === this.modal) this.closeDateModal();
        });

        this.initIntervalButtons('#mainIntervalOptions', false);
        this.initIntervalButtons('#bulkIntervalOptions', true);
        this.initBulkModal();

        this.updateDashboard();
        this.updateCalendar();
    }

    /* -------- Helpers -------- */
    sameDay(d1, d2) {
        d1 = new Date(d1); d2 = new Date(d2);
        return d1.getFullYear() === d2.getFullYear() &&
               d1.getMonth() === d2.getMonth() &&
               d1.getDate() === d2.getDate();
    }
    dayStart(date) { const d = new Date(date); d.setHours(0,0,0,0); return d; }
    dayEnd(date) { const d = new Date(date); d.setHours(23,59,59,999); return d; }
    formatLong(date) {
        return new Date(date).toLocaleDateString(undefined, {
            weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'
        });
    }

    /* -------- Intervals UI -------- */
    initIntervalButtons(containerSelector, isBulk) {
        const container = document.querySelector(containerSelector);
        const btns = container.querySelectorAll('.interval-btn');
        btns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const daysVal = btn.dataset.days;
                const list = isBulk ? this.bulkSelectedIntervals : this.selectedIntervals;

                if (daysVal === 'custom') {
                    (isBulk ? document.getElementById('bulkCustomWrap') : document.getElementById('customInterval')).classList.add('show');
                    return;
                }

                const days = parseInt(daysVal, 10);
                if (btn.classList.contains('selected')) {
                    btn.classList.remove('selected');
                    const idx = list.indexOf(days);
                    if (idx > -1) list.splice(idx,1);
                } else {
                    btn.classList.add('selected');
                    if (!list.includes(days)) list.push(days);
                }
                this.updateIntervalsListDisplay(isBulk);
            });
        });

        // Custom add buttons
        if (isBulk) {
            const customBtn = document.getElementById('bulkAddCustomBtn');
            customBtn.addEventListener('click', () => {
                const customDays = parseInt(document.getElementById('bulkCustomDays').value, 10);
                if (customDays && customDays > 0 && !this.bulkSelectedIntervals.includes(customDays)) {
                    this.bulkSelectedIntervals.push(customDays);
                    this.updateIntervalsListDisplay(true);
                    document.getElementById('bulkCustomDays').value = '';
                    document.getElementById('bulkCustomWrap').classList.remove('show');
                }
            });
        }
    }

    addCustomInterval() {
        const customDays = parseInt(document.getElementById('customDays').value);
        if (customDays && customDays > 0 && !this.selectedIntervals.includes(customDays)) {
            this.selectedIntervals.push(customDays);
            this.updateIntervalsListDisplay(false);
            document.getElementById('customDays').value = '';
            document.getElementById('customInterval').classList.remove('show');
        }
    }

    updateIntervalsListDisplay(isBulk) {
        if (isBulk) {
            // show selection as helper in preview header (no dedicated list UI here)
            this.updateBulkPreview();
        } else {
            const intervalsList = document.getElementById('intervalsList');
            if (this.selectedIntervals.length === 0) {
                intervalsList.innerHTML = 'None selected — please choose at least one interval';
                intervalsList.style.color = '#fbbf24';
            } else {
                const sorted = [...this.selectedIntervals].sort((a,b)=>a-b);
                intervalsList.innerHTML = sorted.map(days => {
                    if (days === 1) return '1 day';
                    if (days === 7) return '1 week';
                    if (days === 14) return '2 weeks';
                    if (days === 30) return '1 month';
                    return `${days} days`;
                }).join(' • ');
                intervalsList.style.color = '#34d399';
            }
        }
    }

    /* ---------- Bulk Add ---------- */
    initBulkModal() {
        const bulkModal = document.getElementById('bulkModal');
        const tabs = document.querySelectorAll('.tab');
        const panels = {
            paste: document.getElementById('tab-paste'),
            upload: document.getElementById('tab-upload')
        };

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const key = tab.dataset.tab;
                Object.values(panels).forEach(p => p.classList.remove('show'));
                panels[key].classList.add('show');
            });
        });

        // Open/close
        document.getElementById('bulkCloseBtn').addEventListener('click', () => this.closeBulkModal());
        document.getElementById('bulkCancel').addEventListener('click', () => this.closeBulkModal());
        bulkModal.addEventListener('click', (e) => {
            if (e.target.id === 'bulkModal') this.closeBulkModal();
        });

        // CSV choose
        document.getElementById('chooseCsvBtn').addEventListener('click', () => document.getElementById('bulkFile').click());
        document.getElementById('bulkFile').addEventListener('change', (e) => this.handleCsvFile(e));

        // Paste live preview
        document.getElementById('bulkPaste').addEventListener('input', () => this.updateBulkPreview());

        // Confirm
        document.getElementById('bulkConfirm').addEventListener('click', () => this.confirmBulkAdd());
    }

    openBulkModal() {
        // reset view
        document.getElementById('bulkPaste').value = '';
        document.getElementById('csvFileName').textContent = '';
        this.bulkSelectedIntervals = [];
        // deselect all bulk interval pills
        document.querySelectorAll('#bulkIntervalOptions .interval-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('bulkCustomWrap').classList.remove('show');

        this.updateBulkPreview();
        document.getElementById('bulkModal').style.display = 'flex';
    }

    closeBulkModal() { document.getElementById('bulkModal').style.display = 'none'; }

    updateBulkPreview() {
        const preview = document.getElementById('bulkPreview');
        const text = document.getElementById('bulkPaste').value || '';
        const rows = this.parseLooseLines(text);

        const intervalsLabel = (this.bulkSelectedIntervals.length
            ? 'Intervals: ' + [...this.bulkSelectedIntervals].sort((a,b)=>a-b).map(d => d+'d').join(' • ')
            : 'No intervals selected');

        if (rows.length === 0) {
            preview.innerHTML = `No items yet.<div class="helper" style="margin-top:6px;">${intervalsLabel}</div>`;
            return;
        }

        preview.innerHTML = `
            <div style="font-weight:700; margin-bottom:6px;">Parsed ${rows.length} topic(s)</div>
            <div class="helper" style="margin-bottom:6px;">${intervalsLabel}</div>
            ${rows.map(r => `<div class="preview-item"><b>${this.escape(r.title)}</b>${r.description ? ' — ' + this.escape(r.description) : ''}</div>`).join('')}
        `;
    }

    handleCsvFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('csvFileName').textContent = file.name;

        const reader = new FileReader();
        reader.onload = (ev) => {
            const text = ev.target.result;
            const rows = this.parseCSV(text);
            // Put into paste box for uniform preview/editing
            const lines = rows.map(r => r.description ? `${r.title}, ${r.description}` : r.title).join('\n');
            document.getElementById('bulkPaste').value = lines;
            this.updateBulkPreview();
        };
        reader.readAsText(file);
    }

    confirmBulkAdd() {
        const text = document.getElementById('bulkPaste').value || '';
        const rows = this.parseLooseLines(text);
        if (rows.length === 0) { alert('No topics to add.'); return; }
        if (this.bulkSelectedIntervals.length === 0) { alert('Select at least one interval for bulk add.'); return; }

        const baseStart = Date.now();
        let baseOffset = 0;

        rows.forEach(row => {
            const baseId = baseStart + (baseOffset++); // ensure unique groups per row
            this.bulkSelectedIntervals.forEach((interval, idx) => {
                const topic = {
                    id: baseId + idx,
                    baseId,
                    title: row.title,
                    description: row.description || '',
                    interval: interval,
                    nextReview: new Date(Date.now() + interval*24*60*60*1000),
                    created: new Date(),
                    completedCount: 0,
                    lastCompleted: null,
                    intervalGroup: this.bulkSelectedIntervals.slice()
                };
                this.topics.push(topic);
            });
        });

        this.saveTopics();
        this.updateDashboard();
        this.updateTopicsList();
        this.updateCalendar();

        this.closeBulkModal();
        alert(`Added ${rows.length} topic(s).`);
    }

    /* ---------- Parsers ---------- */
    parseLooseLines(text) {
        // Accepts lines like:
        // Title
        // Title, Description
        return text
            .split(/\r?\n/)
            .map(l => l.trim())
            .filter(l => l.length > 0)
            .map(l => {
                // If line contains a comma, split into 2 parts (title, description), respecting quotes if any.
                const asCsv = this.parseCSV(l + '\n'); // reuse CSV line parser
                if (asCsv.length > 0 && asCsv[0].title) return asCsv[0];
                // fallback: whole line as title
                return { title: l, description: '' };
            });
    }

    parseCSV(text) {
        // Basic CSV parser handling quotes and commas. Returns array of {title, description}
        const rows = [];
        let cur = [], field = '', inQuotes = false, i = 0;

        const pushField = () => { cur.push(field); field = ''; };
        const pushRow = () => {
            if (cur.length === 1) rows.push({ title: (cur[0] || '').trim(), description: '' });
            else if (cur.length >= 2) rows.push({
                title: (cur[0] || '').trim(),
                description: cur.slice(1).join(',').trim()
            });
            cur = [];
        };

        while (i < text.length) {
            const ch = text[i];
            if (inQuotes) {
                if (ch === '"') {
                    if (text[i+1] === '"') { field += '"'; i++; } // escaped quote
                    else { inQuotes = false; }
                } else field += ch;
            } else {
                if (ch === '"') inQuotes = true;
                else if (ch === ',') pushField();
                else if (ch === '\n' || ch === '\r') {
                    if (field.length || cur.length) { pushField(); pushRow(); }
                    // consume potential \r\n
                    if (ch === '\r' && text[i+1] === '\n') i++;
                } else field += ch;
            }
            i++;
        }
        if (field.length || cur.length) { pushField(); pushRow(); }

        // Strip header if looks like one
        if (rows.length && /title/i.test(rows[0].title) && (/desc/i.test(rows[0].description) || /description/i.test(rows[0].description))) {
            rows.shift();
        }

        // Filter empty titles
        return rows.filter(r => r.title && r.title.trim().length > 0);
    }

    escape(s) {
        return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    /* -------- CRUD -------- */
    addTopic() {
        const title = document.getElementById('topicTitle').value.trim();
        const description = document.getElementById('topicDescription').value.trim();

        if (!title) { alert('Please enter a topic title'); return; }
        if (this.selectedIntervals.length === 0) { alert('Please select at least one review interval'); return; }

        const baseId = Date.now();
        this.selectedIntervals.forEach((interval, index) => {
            const topic = {
                id: baseId + index,
                baseId: baseId,
                title,
                description,
                interval: interval,
                nextReview: new Date(Date.now() + interval * 24 * 60 * 60 * 1000),
                created: new Date(),
                completedCount: 0,
                lastCompleted: null,
                intervalGroup: this.selectedIntervals.slice()
            };
            this.topics.push(topic);
        });

        this.saveTopics();
        this.updateDashboard();
        this.updateTopicsList();
        this.updateCalendar();

        document.getElementById('topicTitle').value = '';
        document.getElementById('topicDescription').value = '';
        this.selectedIntervals = [];
        this.updateIntervalsListDisplay(false);
        document.querySelectorAll('#mainIntervalOptions .interval-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('customInterval').classList.remove('show');

        showTab('dashboard');
    }

    completeTopic(topicId) {
        const topic = this.topics.find(t => t.id === topicId);
        if (!topic) return;

        topic.lastCompleted = new Date();
        topic.completedCount++;
        topic.nextReview = new Date(Date.now() + topic.interval * 24 * 60 * 60 * 1000);

        if (!this.completedToday.includes(topic.baseId)) {
            this.completedToday.push(topic.baseId);
            localStorage.setItem('completedToday', JSON.stringify(this.completedToday));
        }

        this.saveTopics();
        this.updateDashboard();
        this.updateTopicsList();
        this.updateCalendar();
    }

    deleteTopic(topicId) {
        const topic = this.topics.find(t => t.id === topicId);
        if (!topic) return;

        if (confirm('Are you sure you want to delete this topic? This will remove ALL intervals for this topic.')) {
            this.topics = this.topics.filter(t => t.baseId !== topic.baseId);
            this.saveTopics();
            this.updateDashboard();
            this.updateTopicsList();
            this.updateCalendar();
        }
    }

    /* -------- Queries -------- */
    getDueTopics() {
        const now = new Date(); now.setHours(23, 59, 59, 999);
        return this.topics.filter(topic => new Date(topic.nextReview) <= now);
    }

    getTopicsForDate(date) {
        const start = this.dayStart(date);
        const end = this.dayEnd(date);
        return this.topics.filter(topic => {
            const reviewDate = new Date(topic.nextReview);
            return reviewDate >= start && reviewDate <= end;
        });
    }

    getReviewedOnDate(date) {
        const start = this.dayStart(date);
        const end = this.dayEnd(date);
        return this.topics.filter(topic => {
            if (!topic.lastCompleted) return false;
            const lc = new Date(topic.lastCompleted);
            return lc >= start && lc <= end;
        });
    }

    /* -------- UI Update -------- */
    updateDashboard() {
        const dueTopics = this.getDueTopics();
        const uniqueBaseDue = [...new Set(dueTopics.map(t => t.baseId))];
        const uniqueBaseTotal = [...new Set(this.topics.map(t => t.baseId))];

        document.getElementById('statsDue').textContent = uniqueBaseDue.length;
        document.getElementById('statsTotal').textContent = uniqueBaseTotal.length;
        document.getElementById('statsCompleted').textContent = this.completedToday.length;

        const groupedDueTopics = {};
        dueTopics.forEach(topic => {
            if (!groupedDueTopics[topic.baseId]) {
                groupedDueTopics[topic.baseId] = { ...topic, intervals: [] };
            }
            groupedDueTopics[topic.baseId].intervals.push(topic.interval);
        });

        const todayList = document.getElementById('todayTopicsList');
        if (Object.keys(groupedDueTopics).length === 0) {
            todayList.innerHTML = '<div class="no-topics">🎉 No topics due today! Great job!</div>';
        } else {
            todayList.innerHTML = Object.values(groupedDueTopics).map(topic => `
                <div class="topic-item">
                    <div class="topic-info">
                        <div class="topic-title">${topic.title}</div>
                        ${topic.description ? `<div class="topic-description">${topic.description}</div>` : ''}
                        <div class="topic-meta">
                            Due intervals: ${topic.intervals.sort((a,b) => a-b).map(i => i + 'd').join(', ')} |
                            Completed: ${topic.completedCount} times
                        </div>
                    </div>
                    <div class="topic-actions">
                        <button class="action-btn complete" onclick="app.completeTopicGroup(${topic.baseId})">✓ Complete All</button>
                    </div>
                </div>
            `).join('');
        }
    }

    completeTopicGroup(baseId) {
        const topicsInGroup = this.topics.filter(t => t.baseId === baseId);
        const dueTopicsInGroup = topicsInGroup.filter(topic => {
            const now = new Date(); now.setHours(23, 59, 59, 999);
            return new Date(topic.nextReview) <= now;
        });

        dueTopicsInGroup.forEach(topic => {
            topic.lastCompleted = new Date();
            topic.completedCount++;
            topic.nextReview = new Date(Date.now() + topic.interval * 24 * 60 * 60 * 1000);
        });

        if (!this.completedToday.includes(baseId)) {
            this.completedToday.push(baseId);
            localStorage.setItem('completedToday', JSON.stringify(this.completedToday));
        }

        this.saveTopics();
        this.updateDashboard();
        this.updateTopicsList();
        this.updateCalendar();
    }

    updateTopicsList() {
        const topicList = document.getElementById('topicList');
        if (this.topics.length === 0) {
            topicList.innerHTML = '<div class="no-topics">No topics added yet. Add your first topic!</div>';
            return;
        }

        const groupedTopics = {};
        this.topics.forEach(topic => {
            if (!groupedTopics[topic.baseId]) {
                groupedTopics[topic.baseId] = { ...topic, intervals: [], nextReviews: [] };
            }
            groupedTopics[topic.baseId].intervals.push(topic.interval);
            groupedTopics[topic.baseId].nextReviews.push(new Date(topic.nextReview));
        });

        const sortedTopics = Object.values(groupedTopics).sort((a, b) =>
            Math.min(...a.nextReviews) - Math.min(...b.nextReviews)
        );

        topicList.innerHTML = sortedTopics.map(topic => {
            const nextReview = Math.min(...topic.nextReviews);
            const nextReviewDate = new Date(nextReview);
            const now = new Date();
            const isOverdue = nextReviewDate < this.dayStart(now);
            const isDueToday = this.sameDay(nextReviewDate, now);

            let statusClass = 'status-future';
            let statusText = 'Scheduled';
            if (isOverdue || isDueToday) { statusClass = 'status-due'; statusText = 'Due'; }
            if (this.completedToday.includes(topic.baseId)) { statusClass = 'status-completed'; statusText = 'Completed'; }

            const sortedIntervals = topic.intervals.sort((a,b) => a-b);

            return `
                <div class="topic-item">
                    <div class="topic-info">
                        <div class="topic-title">
                            ${topic.title}
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        ${topic.description ? `<div class="topic-description">${topic.description}</div>` : ''}
                        <div class="topic-meta">
                            Next review: ${nextReviewDate.toLocaleDateString()} |
                            Intervals: ${sortedIntervals.map(i => i + 'd').join(', ')} |
                            Completed: ${topic.completedCount} times
                        </div>
                    </div>
                    <div class="topic-actions">
                        ${!this.completedToday.includes(topic.baseId) && (isOverdue || isDueToday) ?
                            `<button class="action-btn complete" onclick="app.completeTopicGroup(${topic.baseId})">✓ Complete</button>` : ''
                        }
                        <button class="action-btn delete" onclick="app.deleteTopic(${topic.id})">🗑️</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    updateCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();

        document.getElementById('currentMonth').textContent =
            new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const calendarGrid = document.getElementById('calendarGrid');
        calendarGrid.innerHTML = '';

        // Day headers (non-clickable)
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day header-cell';
            dayHeader.style.fontWeight = 'bold';
            dayHeader.style.background = 'rgba(255, 255, 255, 0.2)';
            dayHeader.textContent = day;
            dayHeader.style.cursor = 'default';
            calendarGrid.appendChild(dayHeader);
        });

        // 6 weeks grid
        for (let i = 0; i < 42; i++) {
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + i);

            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';

            if (currentDate.getMonth() !== month) dayElement.classList.add('other-month');
            if (this.sameDay(currentDate, new Date())) dayElement.classList.add('today');

            const topicsForDay = this.getTopicsForDate(currentDate);
            dayElement.innerHTML = `
                <div class="day-number">${currentDate.getDate()}</div>
                <div class="day-topics">
                    ${topicsForDay.map(() => '<span class="topic-dot"></span>').join('')}
                    ${topicsForDay.length > 5 ? `<div style="font-size: 0.6em;">+${topicsForDay.length - 5} more</div>` : ''}
                </div>
            `;
            if (topicsForDay.length > 0) {
                dayElement.title = topicsForDay.map(t => t.title).join(', ');
            }

            // Make each date clickable -> open modal
            dayElement.addEventListener('click', () => this.openDateModal(currentDate));

            calendarGrid.appendChild(dayElement);
        }
    }

    changeMonth(direction) {
        this.currentDate.setMonth(this.currentDate.getMonth() + direction);
        this.updateCalendar();
    }
    goToToday() { this.currentDate = new Date(); this.updateCalendar(); }

    /* -------- Modal logic -------- */
    // Build grouped objects keyed by baseId with intervals array
    groupByBaseWithIntervals(items) {
        const map = {};
        items.forEach(t => {
            if (!map[t.baseId]) {
                map[t.baseId] = { title: t.title, description: t.description, completedCount: t.completedCount, intervals: [] };
            }
            map[t.baseId].intervals.push(t.interval);
        });
        return map;
    }

    openDateModal(date) {
        const scheduled = this.getTopicsForDate(date);
        const reviewed = this.getReviewedOnDate(date);

        const scheduledByBase = this.groupByBaseWithIntervals(scheduled);
        const reviewedByBase = this.groupByBaseWithIntervals(reviewed);

        // Pending = scheduled but not reviewed on that same date
        const pendingByBase = {};
        Object.keys(scheduledByBase).forEach(baseId => {
            if (!reviewedByBase[baseId]) pendingByBase[baseId] = scheduledByBase[baseId];
        });

        const totalScheduled = Object.keys(scheduledByBase).length;
        const totalReviewed = Object.keys(reviewedByBase).length;
        const totalPending = Object.keys(pendingByBase).length;

        // Fill header + summary
        document.getElementById('modalDate').textContent = `📅 ${this.formatLong(date)}`;
        document.getElementById('modalSummary').innerHTML =
            `📌 Total Scheduled: <strong>${totalScheduled}</strong> &nbsp;•&nbsp; 
             ✅ Reviewed: <strong style="color:#34d399">${totalReviewed}</strong> &nbsp;•&nbsp; 
             🕑 Pending: <strong style="color:#fbbf24">${totalPending}</strong>`;

        // Fill Pending cards
        const pendingList = document.getElementById('modalPendingList');
        if (totalPending === 0) {
            pendingList.innerHTML = `<div class="no-topics" style="padding:16px;">No pending topics.</div>`;
        } else {
            pendingList.innerHTML = Object.values(pendingByBase).map(item => {
                const intervalsText = [...item.intervals].sort((a,b)=>a-b).map(i=>`${i}d`).join(', ');
                return `
                <div class="note-card pending">
                    <div class="card-left">
                        <div class="card-title">${item.title}</div>
                        ${item.description ? `<div class="card-meta">${item.description}</div>` : ''}
                        <div class="card-meta">
                            <span class="pill">Intervals due: ${intervalsText}</span>
                            <span class="pill">Completed: ${item.completedCount}×</span>
                        </div>
                    </div>
                    <div><span class="chip chip-pending">Pending</span></div>
                </div>`;
            }).join('');
        }

        // Fill Reviewed cards
        const reviewedList = document.getElementById('modalReviewedList');
        if (totalReviewed === 0) {
            reviewedList.innerHTML = `<div class="no-topics" style="padding:16px;">Nothing reviewed this day.</div>`;
        } else {
            reviewedList.innerHTML = Object.values(reviewedByBase).map(item => {
                const intervalsText = item.intervals?.length ? [...item.intervals].sort((a,b)=>a-b).map(i=>`${i}d`).join(', ') : '—';
                return `
                <div class="note-card reviewed">
                    <div class="card-left">
                        <div class="card-title">${item.title}</div>
                        ${item.description ? `<div class="card-meta">${item.description}</div>` : ''}
                        <div class="card-meta">
                            <span class="pill">Intervals (group): ${intervalsText}</span>
                            <span class="pill">Completed: ${item.completedCount}×</span>
                        </div>
                    </div>
                    <div><span class="chip chip-reviewed">Reviewed</span></div>
                </div>`;
            }).join('');
        }

        // Show/hide sections based on content
        document.getElementById('pendingSection').style.display = 'block';
        document.getElementById('reviewedSection').style.display = 'block';

        // Open modal
        this.modal.style.display = 'flex';
    }

    closeDateModal() { this.modal.style.display = 'none'; }

    /* -------- Persist -------- */
    saveTopics() { localStorage.setItem('srTopics', JSON.stringify(this.topics)); }
}

/* -------- App bootstrap + global helpers -------- */
const app = new TopicSpacedRepetition();

function showTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');

    if (tabName === 'topics') app.updateTopicsList();
    else if (tabName === 'calendar') app.updateCalendar();
    else if (tabName === 'dashboard') app.updateDashboard();
}

function changeMonth(direction) { app.changeMonth(direction); }
function goToToday() { app.goToToday(); }
function addTopic() { app.addTopic(); }
function addCustomInterval() { app.addCustomInterval(); }
function openBulkModal() { app.openBulkModal(); }
</script>
</body>
</html>
